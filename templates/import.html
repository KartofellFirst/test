<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
	<style>
		.dropdown-results {
			margin-top: 10px;
			border: 1px solid #ccc;
			max-height: 200px;
			overflow-y: auto;
			padding: 5px;
		}
		
		.dropdown-item {
			padding: 8px;
			cursor: pointer;
			border-bottom: 1px solid #eee;
		}
		
		.dropdown-item:hover {
			background-color: #f0f0f0;
		}
	</style>
</head>
<body>
    <!-- import.html -->
	<div class="modal-content">
		<h2>–ò–º–ø–æ—Ä—Ç —Ç—Ä–µ–∫–∞</h2>
		
		<!-- üîä –§–æ—Ä–º–∞ Spotify -->
		<form id="spotify-form" onsubmit="event.preventDefault(); searchSpotify();">
			<h3>üîç –ù–∞–π—Ç–∏ —Ç—Ä–µ–∫ —á–µ—Ä–µ–∑ Spotify</h3>
			
			<!-- –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é -->
			<label for="spotify-title">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞</label>
			<input type="text" id="spotify-title" name="spotify-title" autocomplete="off" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ...">
			
			<!-- Dropdown —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ -->
			<div id="spotify-dropdown" class="dropdown-results"></div>
			
			<!-- –í–≤–æ–¥ URL -->
			<label for="spotify-url">Spotify URL (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>
			<input type="text" id="spotify-url" name="spotify-url" placeholder="https://open.spotify.com/track/...">
			<button type="button" onclick="urlCheck()">üîé –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏</button>
		</form>
		<div id="audio-div"></div>
		<!-- üîó –í—Ç–æ—Ä–∞—è —Ñ–æ—Ä–º–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ -->
		<!-- <form id="external-form">...</form> -->
	</div>
	
	<script>
	let selectedTitle = null;
	let selectedAuthor = null;
	let selectedId = null;

  // üîç –ê–≤—Ç–æ–ø–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
	
	// ‚è≥ Debounce-—Ç–∞–π–º–µ—Ä
	let inputTimer = null;
	
    document.getElementById("spotify-title").addEventListener("input", function () {
        const query = this.value;
        if (!query.trim()) return;
        
        clearTimeout(inputTimer);
        inputTimer = setTimeout(() => {
            searchSpotify(query);
        }, 600); // 600 –º—Å –∑–∞–¥–µ—Ä–∂–∫–∞ ‚Äî –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å
    });
	
	async function searchSpotify(query) {
        try {
            const res = await fetch(`/search/title?q=${encodeURIComponent(query)}`);
            const data = await res.json();
            const dropdown = document.getElementById("spotify-dropdown");
            dropdown.innerHTML = "";
            
            data.slice(0, 3).forEach(track => {
              const el = document.createElement("div");
              el.className = "dropdown-item";
              el.innerHTML = `
                <strong>${track.title}</strong> ‚Äî ${track.author}
                <br><small>–ñ–∞–Ω—Ä—ã: ${track.genres}</small>
              `;
              el.onclick = () => {
                selectedTitle = track.title;
                selectedAuthor = track.author;
                selectedId = track.id;
                dropdown.innerHTML = `<div class="dropdown-selected">–í—ã –≤—ã–±—Ä–∞–ª–∏: <strong>${selectedTitle}</strong> ‚Äî ${selectedAuthor}</div>`;
              };
              dropdown.appendChild(el);
            });
        } catch (err) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", err);
        }
	}

    async function urlCheck() {
        let url = document.getElementById("spotify-url").value;
        url = convertDriveUrl(url);
        document.getElementById("spotify-url").value = url;
        const res = await fetch("/url-check", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url: url })
        })
        const data = await res.json();
        if (data.success) {
            const audio = document.createElement("audio");
            audio.src = data.filename;
            audio.controls = true;
            audio.autoplay = true;
            document.querySelector("#audio-div").innerHTML = "";
            document.querySelector("#audio-div").appendChild(audio);

            audio.addEventListener("canplaythrough", async () => {
                await fetch("/delete", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ filename: data.filename })
                });
            }, { once: true });
        }
    }

    function convertDriveUrl(originalUrl) {
      // –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
      if (originalUrl.includes("uc?export=download&id=")) {
        return originalUrl;
      }
    
      // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç —Ç–∏–ø–∞ /file/d/ID/view
      const match = originalUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
      if (match && match[1]) {
        const fileId = match[1];
        return `https://drive.google.com/uc?export=download&id=${fileId}`;
      }
    
      // –ï—Å–ª–∏ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ
      return null;
    }
</script>
</body>
</html>
