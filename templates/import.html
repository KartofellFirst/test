<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
	<style>
		.dropdown-results {
			margin-top: 10px;
			border: 1px solid #ccc;
			max-height: 200px;
			overflow-y: auto;
			padding: 5px;
		}
		
		.dropdown-item {
			padding: 8px;
			cursor: pointer;
			border-bottom: 1px solid #eee;
		}
		
		.dropdown-item:hover {
			background-color: #f0f0f0;
		}
	</style>
</head>
<body>
    <!-- import.html -->
	<div class="modal-content">
		<h2>–ò–º–ø–æ—Ä—Ç —Ç—Ä–µ–∫–∞</h2>
		
		<!-- üîä –§–æ—Ä–º–∞ Spotify -->
		<form id="spotify-form" onsubmit="event.preventDefault(); searchSpotify();">
			<h3>üîç –ù–∞–π—Ç–∏ —Ç—Ä–µ–∫ —á–µ—Ä–µ–∑ Spotify</h3>
			
			<!-- –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é -->
			<label for="spotify-title">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞</label>
			<input type="text" id="spotify-title" name="spotify-title" autocomplete="off" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ...">
			
			<!-- Dropdown —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ -->
			<div id="spotify-dropdown" class="dropdown-results"></div>
			
			<!-- –í–≤–æ–¥ URL -->
			<label for="spotify-url">Spotify URL (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>
			<input type="text" id="spotify-url" name="spotify-url" placeholder="https://open.spotify.com/track/...">
			<button type="button" onclick="fetchSpotifyData()">üîé –ò—Å–∫–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</button>
		</form>
		
		<!-- üîó –í—Ç–æ—Ä–∞—è —Ñ–æ—Ä–º–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ -->
		<!-- <form id="external-form">...</form> -->
	</div>
	
	<script>
  let selectedTitle = null;
  let selectedAuthor = null;
  let selectedId = null;

  // üîç –ê–≤—Ç–æ–ø–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
  document.getElementById("spotify-title").addEventListener("input", async function () {
    const query = this.value;
    if (!query.trim()) return;

    const res = await fetch(`/search/title?q=${encodeURIComponent(query)}`);
    const data = await res.json();
    const dropdown = document.getElementById("spotify-dropdown");
    dropdown.innerHTML = "";

    data.slice(0, 3).forEach(track => {
      const el = document.createElement("div");
      el.className = "dropdown-item";
      el.innerHTML = `
        <strong>${track.title}</strong> ‚Äî ${track.author}
        <br><small>–ñ–∞–Ω—Ä—ã: ${track.genres}</small>
      `;
      el.onclick = () => {
        selectedTitle = track.title;
        selectedAuthor = track.author;
	selectedId = track.id;
        dropdown.innerHTML = `<div class="dropdown-selected">–í—ã –≤—ã–±—Ä–∞–ª–∏: <strong>${selectedTitle}</strong> ‚Äî ${selectedAuthor}</div>`;
      };
      dropdown.appendChild(el);
    });
  });

  // üéØ –ê–≤—Ç–æ–ø–æ–∏—Å–∫ —Å—Å—ã–ª–∫–∏ –ø–æ –∏–º–µ–Ω–∏ + –∞–≤—Ç–æ—Ä—É
  async function fetchSpotifyData() {
  if (!selectedTitle || !selectedAuthor || !selectedId) {
    alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫ –∏–∑ —Å–ø–∏—Å–∫–∞");
    return;
  }

  const res = await fetch("/generate-download", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      title: selectedTitle,
      author: selectedAuthor,
      spotify_id: selectedId  // –ø–µ—Ä–µ–¥–∞—ë–º ID
    })
  });

  const result = await res.json();
  if (result.url) {
    alert(`‚úÖ –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ: ${result.url}`);
    // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø–ª–µ–µ—Ä –∏–ª–∏ –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
  } else {
    alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ç—Ä–µ–∫");
  }
}


</script>
</body>
</html>
